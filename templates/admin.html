<!DOCTYPE html>
<html lang="ru">
<head>
  <title>Фильмотека — Администрирование</title>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
  <h1>Панель администратора фильмотеки</h1>
  
  <!-- Формы для добавления новых записей -->
  <div class="card mb-4">
    <div class="card-header">
      <h5>Добавить новую запись</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- Форма для фильмов -->
        <div class="col-md-6 mb-3">
          <h6>Добавить фильм</h6>
          <div class="input-group mb-2">
            <input type="text" id="filmName" class="form-control" placeholder="Название фильма">
          </div>
          <div class="input-group mb-2">
            <input type="number" id="filmYear" class="form-control" placeholder="Год выпуска">
          </div>
          <div class="input-group mb-2">
            <select id="filmDirector" class="form-control">
              <option value="">Выберите режиссёра</option>
            </select>
          </div>
          <button class="btn btn-primary btn-sm" onclick="addFilm()">Добавить фильм</button>
        </div>

        <!-- Форма для носителей -->
        <div class="col-md-6 mb-3">
          <h6>Добавить носитель</h6>
          <div class="input-group mb-2">
            <input type="text" id="carrierType" class="form-control" placeholder="Тип носителя">
          </div>
          <div class="input-group mb-2">
            <input type="text" id="carrierCondition" class="form-control" placeholder="Состояние">
          </div>
          <div class="input-group mb-2">
            <input type="number" step="0.01" id="carrierPrice" class="form-control" placeholder="Цена">
          </div>
          <div class="input-group mb-2">
            <select id="carrierFilm" class="form-control">
              <option value="">Выберите фильм</option>
            </select>
          </div>
          <button class="btn btn-primary btn-sm" onclick="addCarrier()">Добавить носитель</button>
        </div>

        <!-- Форма для пользователей -->
        <div class="col-md-6 mb-3">
          <h6>Добавить пользователя</h6>
          <div class="input-group mb-2">
            <input type="text" id="readerFio" class="form-control" placeholder="ФИО">
          </div>
          <div class="input-group mb-2">
            <input type="text" id="readerPhone" class="form-control" placeholder="Телефон">
          </div>
          <button class="btn btn-primary btn-sm" onclick="addReader()">Добавить пользователя</button>
        </div>

        <!-- Форма для жанров -->
        <div class="col-md-6 mb-3">
          <h6>Добавить жанр</h6>
          <div class="input-group mb-2">
            <input type="text" id="genreName" class="form-control" placeholder="Название жанра">
          </div>
          <button class="btn btn-primary btn-sm" onclick="addGenre()">Добавить жанр</button>
        </div>

        <!-- Форма для режиссёров -->
        <div class="col-md-6 mb-3">
          <h6>Добавить режиссёра</h6>
          <div class="input-group mb-2">
            <input type="text" id="directorName" class="form-control" placeholder="ФИО режиссёра">
          </div>
          <button class="btn btn-primary btn-sm" onclick="addDirector()">Добавить режиссёра</button>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion" id="adminAccordion">

    <!-- Фильмы -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingFilms">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilms">
          Фильмы
        </button>
      </h2>
      <div id="collapseFilms" class="accordion-collapse collapse show">
        <div class="accordion-body">
          <table class="table">
            <thead>
              <tr><th>Название</th><th>Год</th><th>Режиссёр</th><th>Жанры</th><th>Действия</th></tr>
            </thead>
            <tbody id="filmsTableBody">
              {% for f in films %}
              <tr data-film-id="{{ f[0] }}">
                <td>{{ f[1] }}</td>
                <td>{{ f[2] }}</td>
                <td>{{ f[3] }}</td>
                <td>{{ ', '.join(f[4]) }}</td>
                <td>
                  <button class="btn btn-warning btn-sm edit-film-btn" data-film-id="{{ f[0] }}">Редактировать</button>
                  <button class="btn btn-danger btn-sm delete-film-btn" data-film-id="{{ f[0] }}">Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Носители -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingCarriers">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCarriers">
          Носители
        </button>
      </h2>
      <div id="collapseCarriers" class="accordion-collapse collapse">
        <div class="accordion-body">
          <table class="table">
            <thead><tr><th>Тип</th><th>Фильм</th><th>Состояние</th><th>Цена</th><th>Режиссёр</th><th>Действия</th></tr></thead>
            <tbody id="carriersTableBody">
              {% for c in carriers %}
              <tr data-carrier-id="{{ c[0] }}">
                <td>{{ c[1] }}</td>
                <td>{{ c[4] }}</td>
                <td>{{ c[2] }}</td>
                <td>{{ c[3] }}</td>
                <td>{{ c[5] }}</td>
                <td>
                  <button class="btn btn-warning btn-sm edit-carrier-btn" data-carrier-id="{{ c[0] }}">Редактировать</button>
                  <button class="btn btn-danger btn-sm delete-carrier-btn" data-carrier-id="{{ c[0] }}">Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Выдачи -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingIssues">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIssues">
          Выдачи
        </button>
      </h2>
      <div id="collapseIssues" class="accordion-collapse collapse">
        <div class="accordion-body">
          <table class="table">
            <thead><tr>
              <th>Носитель</th><th>Пользователь</th><th>Дата выдачи</th><th>План. возврат</th><th>Факт</th><th>Статус</th><th>Действия</th>
            </tr></thead>
            <tbody id="issuesTableBody">
              {% for i in issues %}
              <tr data-issue-id="{{ i[0] }}">
                <td>{{ i[8] }} ({{ i[9] }})</td>
                <td>{{ i[7] }}</td>
                <td>{{ i[3] }}</td>
                <td>{{ i[4] }}</td>
                <td>{{ i[5] or "-" }}</td>
                <td>{{ i[6] }}</td>
                <td>
                  <button class="btn btn-warning btn-sm edit-issue-btn" data-issue-id="{{ i[0] }}">Изменить</button>
                  <button class="btn btn-danger btn-sm delete-issue-btn" data-issue-id="{{ i[0] }}">Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Пользователи -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingReaders">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReaders">
          Пользователи
        </button>
      </h2>
      <div id="collapseReaders" class="accordion-collapse collapse">
        <div class="accordion-body">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th><th>ФИО</th><th>Телефон</th><th>Дата регистрации</th><th>Статус</th><th>Действия</th>
              </tr>
            </thead>
            <tbody id="readersTableBody">
              {% for r in readers %}
              <tr data-reader-id="{{ r[0] }}">
                <td>{{ r[0] }}</td>
                <td>{{ r[1] }}</td>
                <td>{{ r[2] }}</td>
                <td>{{ r[3] }}</td>
                <td>{{ r[4] }}</td>
                <td>
                  <button class="btn btn-warning btn-sm edit-reader-btn" data-reader-id="{{ r[0] }}">Редактировать</button>
                  <button class="btn btn-danger btn-sm delete-reader-btn" data-reader-id="{{ r[0] }}">Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Жанры -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingGenres">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGenres">
          Жанры
        </button>
      </h2>
      <div id="collapseGenres" class="accordion-collapse collapse">
        <div class="accordion-body">
          <table class="table">
            <thead><tr><th>ID</th><th>Название</th><th>Действия</th></tr></thead>
            <tbody id="genresTableBody">
              {% for g in genres %}
              <tr data-genre-id="{{ g[0] }}">
                <td>{{ g[0] }}</td>
                <td>{{ g[1] }}</td>
                <td>
                  <button class="btn btn-warning btn-sm edit-genre-btn" data-genre-id="{{ g[0] }}">Редактировать</button>
                  <button class="btn btn-danger btn-sm delete-genre-btn" data-genre-id="{{ g[0] }}">Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Режиссёры -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingDirectors">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDirectors">
          Режиссёры
        </button>
      </h2>
      <div id="collapseDirectors" class="accordion-collapse collapse">
        <div class="accordion-body">
          <table class="table">
            <thead><tr><th>ID</th><th>ФИО</th><th>Действия</th></tr></thead>
            <tbody id="directorsTableBody">
              {% for d in directors %}
              <tr data-director-id="{{ d[0] }}">
                <td>{{ d[0] }}</td>
                <td>{{ d[1] }}</td>
                <td>
                  <button class="btn btn-warning btn-sm edit-director-btn" data-director-id="{{ d[0] }}">Редактировать</button>
                  <button class="btn btn-danger btn-sm delete-director-btn" data-director-id="{{ d[0] }}">Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Общие функции для работы с API
  function apiCall(url, method, data = null) {
    return fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: data ? JSON.stringify(data) : null
    }).then(response => response.json());
  }

  // Загрузка данных для форм
  function loadFormData() {
    // Загрузка режиссёров для формы фильма
    apiCall('/api/admin/directors', 'GET')
      .then(directors => {
        const select = document.getElementById('filmDirector');
        select.innerHTML = '<option value="">Выберите режиссёра</option>';
        directors.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = d.name;
          select.appendChild(option);
        });
      });

    // Загрузка фильмов для формы носителя
    apiCall('/api/admin/films', 'GET')
      .then(films => {
        const select = document.getElementById('carrierFilm');
        select.innerHTML = '<option value="">Выберите фильм</option>';
        films.forEach(f => {
          const option = document.createElement('option');
          option.value = f.id;
          option.textContent = f.name;
          select.appendChild(option);
        });
      });
  }

  // Функции для добавления записей
  window.addFilm = function() {
    const name = document.getElementById('filmName').value;
    const year = document.getElementById('filmYear').value;
    const directorId = document.getElementById('filmDirector').value;

    if (!name || !year || !directorId) {
      alert('Заполните все поля');
      return;
    }

    const filmData = {
      name: name,
      year: parseInt(year),
      director_id: parseInt(directorId),
      genre_ids: [] // Упрощённо - без выбора жанров
    };

    apiCall('/api/admin/films', 'POST', filmData)
      .then(data => {
        if (data.success) {
          alert('Фильм успешно добавлен');
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  };

  window.addCarrier = function() {
    const type = document.getElementById('carrierType').value;
    const condition = document.getElementById('carrierCondition').value;
    const price = document.getElementById('carrierPrice').value;
    const filmId = document.getElementById('carrierFilm').value;

    if (!type || !condition || !price || !filmId) {
      alert('Заполните все поля');
      return;
    }

    const carrierData = {
      type: type,
      condition: condition,
      price: parseFloat(price),
      film_id: parseInt(filmId)
    };

    apiCall('/api/admin/carriers', 'POST', carrierData)
      .then(data => {
        if (data.success) {
          alert('Носитель успешно добавлен');
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  };

  window.addReader = function() {
    const fio = document.getElementById('readerFio').value;
    const phone = document.getElementById('readerPhone').value;

    if (!fio || !phone) {
      alert('Заполните все поля');
      return;
    }

    const readerData = {
      fio: fio,
      phone: phone,
      reg_date: new Date().toISOString().split('T')[0],
      status: 'Активен'
    };

    apiCall('/api/admin/readers', 'POST', readerData)
      .then(data => {
        if (data.success) {
          alert('Пользователь успешно добавлен');
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  };

  window.addGenre = function() {
    const name = document.getElementById('genreName').value;

    if (!name) {
      alert('Введите название жанра');
      return;
    }

    const genreData = {
      name: name
    };

    apiCall('/api/admin/genres', 'POST', genreData)
      .then(data => {
        if (data.success) {
          alert('Жанр успешно добавлен');
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  };

  window.addDirector = function() {
    const name = document.getElementById('directorName').value;

    if (!name) {
      alert('Введите ФИО режиссёра');
      return;
    }

    const directorData = {
      name: name
    };

    apiCall('/api/admin/directors', 'POST', directorData)
      .then(data => {
        if (data.success) {
          alert('Режиссёр успешно добавлен');
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  };

  // Обработчики для удаления
  document.querySelectorAll('.delete-film-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const filmId = this.getAttribute('data-film-id');
      if (confirm('Вы уверены, что хотите удалить этот фильм?')) {
        deleteFilm(filmId);
      }
    });
  });

  document.querySelectorAll('.delete-carrier-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const carrierId = this.getAttribute('data-carrier-id');
      if (confirm('Вы уверены, что хотите удалить этот носитель?')) {
        deleteCarrier(carrierId);
      }
    });
  });

  document.querySelectorAll('.delete-issue-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const issueId = this.getAttribute('data-issue-id');
      if (confirm('Вы уверены, что хотите удалить эту выдачу?')) {
        deleteIssue(issueId);
      }
    });
  });

  document.querySelectorAll('.delete-reader-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const readerId = this.getAttribute('data-reader-id');
      if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
        deleteReader(readerId);
      }
    });
  });

  document.querySelectorAll('.delete-genre-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const genreId = this.getAttribute('data-genre-id');
      if (confirm('Вы уверены, что хотите удалить этот жанр?')) {
        deleteGenre(genreId);
      }
    });
  });

  document.querySelectorAll('.delete-director-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const directorId = this.getAttribute('data-director-id');
      if (confirm('Вы уверены, что хотите удалить этого режиссёра?')) {
        deleteDirector(directorId);
      }
    });
  });

  function deleteFilm(filmId) {
    apiCall(`/api/admin/films/${filmId}`, 'DELETE')
      .then(data => {
        if (data.success) {
          document.querySelector(`tr[data-film-id="${filmId}"]`).remove();
          alert('Фильм успешно удалён');
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  }

  function deleteCarrier(carrierId) {
    apiCall(`/api/admin/carriers/${carrierId}`, 'DELETE')
      .then(data => {
        if (data.success) {
          document.querySelector(`tr[data-carrier-id="${carrierId}"]`).remove();
          alert('Носитель успешно удалён');
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  }

  function deleteIssue(issueId) {
    apiCall(`/api/admin/issues/${issueId}`, 'DELETE')
      .then(data => {
        if (data.success) {
          document.querySelector(`tr[data-issue-id="${issueId}"]`).remove();
          alert('Выдача успешно удалена');
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  }

  function deleteReader(readerId) {
    apiCall(`/api/admin/readers/${readerId}`, 'DELETE')
      .then(data => {
        if (data.success) {
          document.querySelector(`tr[data-reader-id="${readerId}"]`).remove();
          alert('Пользователь успешно удалён');
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  }

  function deleteGenre(genreId) {
    apiCall(`/api/admin/genres/${genreId}`, 'DELETE')
      .then(data => {
        if (data.success) {
          document.querySelector(`tr[data-genre-id="${genreId}"]`).remove();
          alert('Жанр успешно удалён');
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  }

  function deleteDirector(directorId) {
    apiCall(`/api/admin/directors/${directorId}`, 'DELETE')
      .then(data => {
        if (data.success) {
          document.querySelector(`tr[data-director-id="${directorId}"]`).remove();
          alert('Режиссёр успешно удалён');
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  }

  loadFormData();
});
</script>
</body>
</html>
